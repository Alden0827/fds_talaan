{% extends 'base.html' %}

{% block title %}4Ps Talaan ng Pagbabago at Pag-unlad{% endblock %}

{% block content %}
<header class="text-center border-bottom pb-3 mb-4">
    <h1>DEPARTMENT OF SOCIAL WELFARE AND DEVELOPMENT</h1>
    <h2>Pantawid Pamilyang Pilipino Program</h2>
    <h3>4Ps TALAAN NG PAGBABAGO AT PAG-UNLAD</h3>
    <h4>Information Sheet</h4>
</header>

<form action="{{ url_for('submit') }}" method="POST">
    <section class="mb-5">
        <h3>Personal Information</h3>
        <div class="row g-3">
            <div class="col-md-6">
                <label for="name" class="form-label">Pangalan:</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="col-md-6">
                <label for="household_id" class="form-label">Household ID number:</label>
                <input type="text" class="form-control" id="household_id" name="household_id" required>
            </div>
            <div class="col-md-4">
                <label for="gender" class="form-label">Kasarian:</label>
                <input type="text" class="form-control" id="gender" name="gender">
            </div>
            <div class="col-md-4">
                <label for="relationship_to_grantee" class="form-label">Relasyon sa Grantee:</label>
                <input type="text" class="form-control" id="relationship_to_grantee" name="relationship_to_grantee">
            </div>
            <div class="col-md-4">
                <label for="contact_number" class="form-label">Contact Number:</label>
                <input type="text" class="form-control" id="contact_number" name="contact_number">
            </div>
            <div class="col-md-4">
                <label for="province" class="form-label">Province:</label>
                <select class="form-select" id="province" name="province" required>
                    <option value="">Select Province</option>
                    {% for province in provinces %}
                        <option value="{{ province }}">{{ province }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="municipality" class="form-label">Municipality:</label>
                <select class="form-select" id="municipality" name="municipality" required>
                    <option value="">Select Municipality</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="barangay" class="form-label">Barangay:</label>
                <select class="form-select" id="barangay" name="barangay" required>
                    <option value="">Select Barangay</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="parent_group_name" class="form-label">Pangalan ng Parent Group:</label>
                <input type="text" class="form-control" id="parent_group_name" name="parent_group_name">
            </div>
        </div>
    </section>

    {% for section_name, questions_in_section in questions.items() %}
    <section class="mb-5">
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <caption>{{ section_name }}</caption>
                {% if questions_in_section[0].question_type == 'rating' %}
                <thead class="table-light">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Mga Pahayag</th>
                        <th scope="col">Score (1-4)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for question in questions_in_section %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td><label for="q-{{ question.id }}">{{ question.text }}</label></td>
                        <td>
                            <input type="number" class="form-control" id="q-{{ question.id }}" name="q-{{ question.id }}" min="1" max="4">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% else %} {# Narrative questions #}
                <tbody>
                    {% for question in questions_in_section %}
                    <tr>
                        <td>
                            <label for="q-{{ question.id }}" class="form-label">{{ question.text }}</label>
                            <textarea class="form-control" id="q-{{ question.id }}" name="q-{{ question.id }}" rows="3"></textarea>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% endif %}
            </table>
        </div>
    </section>
    {% endfor %}

    <div class="text-center mt-5">
        <button type="submit" class="btn btn-primary btn-lg">Submit Assessment</button>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addressData = JSON.parse('{{ address_data | safe }}');
        const provinceSelect = document.getElementById('province');
        const municipalitySelect = document.getElementById('municipality');
        const barangaySelect = document.getElementById('barangay');

        provinceSelect.addEventListener('change', function () {
            const selectedProvince = this.value;
            municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';

            if (selectedProvince && addressData[selectedProvince]) {
                const municipalities = Object.keys(addressData[selectedProvince]);
                municipalities.forEach(function (municipality) {
                    const option = document.createElement('option');
                    option.value = municipality;
                    option.textContent = municipality;
                    municipalitySelect.appendChild(option);
                });
            }
        });

        municipalitySelect.addEventListener('change', function () {
            const selectedProvince = provinceSelect.value;
            const selectedMunicipality = this.value;
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';

            if (selectedProvince && selectedMunicipality && addressData[selectedProvince][selectedMunicipality]) {
                const barangays = addressData[selectedProvince][selectedMunicipality];
                barangays.forEach(function (barangay) {
                    const option = document.createElement('option');
                    option.value = barangay;
                    option.textContent = barangay;
                    barangaySelect.appendChild(option);
                });
            }
        });
    });
</script>
{% endblock %}
