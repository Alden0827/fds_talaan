{% extends 'base.html' %}

{% block title %}4Ps Talaan ng Pagbabago at Pag-unlad{% endblock %}

{% block content %}
<header class="text-center border-bottom pb-3 mb-4">
    <h1>DEPARTMENT OF SOCIAL WELFARE AND DEVELOPMENT</h1>
    <h2>Pantawid Pamilyang Pilipino Program</h2>
    <h3>4Ps TALAAN NG PAGBABAGO AT PAG-UNLAD</h3>
    <h4>Information Sheet</h4>
</header>
<style>
.hidden {
    display: none !important;
}
</style>

<section class="mb-4">
    <p>
        Ang <strong>"Pantawid Pamilyang Pilipino Program (4Ps) Talaan ng Pagbabago at Pag-unlad"</strong> 
        ay isang beneficiary self-assessment tool na idinisenyo upang sukatin at subaybayan ang inyong 
        pag-unlad o pagbabago sa mga partner-beneficiaries ng 4Ps.
    </p>
    <p>
        Ito ay sistematikong pamamaraan na nagbibigay-daan upang makita ang resulta mula sa paglahok sa 4Ps. 
        Isa rin itong kasangkapan na magsisilbing gabay sa pagpaplano at pagpapatupad ng mga programa at serbisyo 
        tulad ng Family Development Session (FDS), para sa mga pamilyang benepisyaryo ng 4Ps.
    </p>

    <h5 class="mt-3">Ang 4Ps Talaan ng Pagbabago at Pag-unlad ay nakatuon sa:</h5>
    <ol>
        <li>
            <strong>Katatasan sa Programa</strong><br>
            Pag-unawa ng mga benepisyaryo sa mga pangunahing layunin, pamantayan at kondisyon ng programa 
            at kamalayan sa 4Ps.
        </li>
        <li>
            <strong>Edukasyon</strong><br>
            Kamalayan ng mga benepisyaryo sa mga kondisyon sa edukasyon, pagtiyak na ang mga bata ay regular 
            na pumapasok sa paaralan, at pagsuporta ng mga tagapag-alaga sa edukasyon ng kanilang mga anak.
        </li>
        <li>
            <strong>Kalusugan</strong><br>
            Pagsubaybay sa mga kondisyon ng kalusugan at pagtiyak ng access sa mahahalagang serbisyong pangkalusugan.
        </li>
        <li>
            <strong>Nutrisyon</strong><br>
            Pagtataguyod ng malusog na mga gawi sa pagkain, pagpapalakas sa seguridad sa pagkain, 
            at pagtiyak ng wastong paglaki at pag-unlad ng mga bata.
        </li>
        <li>
            <strong>Pamamahala sa buhay pamilya</strong><br>
            Pangkalahatang kagalingan at pamamahala ng buhay pamilya, pagtataguyod ng kabuuang pag-unlad ng pamilya 
            at papel nito sa loob ng mas malawak na komunidad.
        </li>
        <li>
            <strong>Kabuhayan at Kaalaman sa Pananalapi</strong><br>
            Naglalayong suriin at pahusayin ang kaalaman sa pananalapi at kabuhayan ng mga pamilya. 
            Ang mga pahayag na ito ay tumutukoy sa pagsubaybay at pagsulong ng mahahalagang kasanayan 
            sa pananalapi at pag-uugali na kinakailangan para sa katatagan at paglago ng ekonomiya.
        </li>
    </ol>

    <p>
        <strong>Ang pagsusuri ay may dalawang bahagi.</strong> Ang unang bahagi ay pagsagot sa mga pahayag gamit ang 
        sukat ng likert (marka mula 1-4) at ang ikalawang bahagi ay pagsisiyasat ng mga tanong sa pamamagitan ng 
        pasalaysay na sagot.
    </p>
    <hr>
    <p>
        <strong>Alinsunod sa Data Privacy Act of 2012 (R.A. 10173)</strong>, tungkulin ng DSWD na protektahan ang mga datos 
        at impormasyong inyong ibinahagi. Tinitiyak namin na hindi gagamitin ang mga impormasyong ito maliban sa layuning 
        itinakda ng talaan na ito. Ang inyong paglagda dito ay pagbibigay pahintulot sa DSWD na gamitin ang mga datos at 
        impormasyon na aming nakalap mula sa inyo.
    </p>
    <hr>
    <p>
        <strong>Panuto:</strong> Basahing mabuti ang mga sumusunod na pahayag. Tiyakin na ang inyong mga sagot ay naaayon 
        sa inyong karanasan at pagkaunawa sa mga pahayag. Mula 1 hanggang 4, suriin ang inyong kaalaman, at ilagay ang 
        wastong marka na sa palagay mo ay akma sa pahayag. Tandaan, walang maling sagot.
    </p>
    <ul>
        <li>4 - Lubos na sumasang-ayon</li>
        <li>3 - Sumasang-ayon</li>
        <li>2 - Hindi Sumasang-ayon</li>
        <li>1 - Lubos na Hindi Sumasang-ayon</li>
        <li>N/A - Hindi angkop ang pahayag para sa sambahayan</li>
    </ul>
</section>


<form action="{{ url_for('submit') }}" method="POST" class="needs-validation" novalidate>
    <section class="glass-panel-0 mb-4">
        <h3>Search</h3>
        <div class="question-grid">
            <div class="question-item">
                <label for="household_id" class="form-label required">Household ID number:</label>
                <input type="text" class="form-control mb-3" id="household_id" name="household_id" value="045810001-9412-00043" required>
               <button type="button" id="btnSearch" class="btn btn-primary mt-2">
                    <i class="fas fa-search"></i> Search
                </button>
                <div id="alertContainer"></div>
            </div>
            

        </div>
     </section>
   
    <section class="glass-panel-0 mb-4 survey-form hidden">
        <h3>Personal Information</h3>
        <div class="question-grid">
            <div class="question-item">
                <label for="name" class="form-label required">Pangalan:</label>
                <input type="text" class="form-control" id="name" name="name" required>
                <div class="invalid-feedback">Pangalan ay kailangan.</div>
            </div>
            <div class="question-item">
                <label for="gender" class="form-label required">Kasarian:</label>
                <select class="form-select" id="gender" name="gender" required>
                    <option value="" disabled selected hidden>Pumili</option>
                    <option value="Babae">Babae</option>
                    <option value="Lalaki">Lalaki</option>
                </select>
                <div class="invalid-feedback">Pumili ng kasarian.</div>
            </div>
            <div class="question-item">
                <label for="relationship_to_grantee" class="form-label required">Relasyon sa Grantee:</label>
                <input type="text" class="form-control" id="relationship_to_grantee" name="relationship_to_grantee" required>
                <div class="invalid-feedback">Relasyon sa grantee ay kailangan.</div>
            </div>
            <div class="question-item">
                <label for="contact_number" class="form-label">Contact Number:</label>
                <input type="text" class="form-control" id="contact_number" name="contact_number">
            </div>
            <div class="question-item">
                <label for="province" class="form-label required">Province:</label>
                <select class="form-select" id="province" name="province" required>
                    <option value="" disabled selected hidden>Select Province</option>
                    {% for province in provinces %}
                        <option value="{{ province }}">{{ province }}</option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback">Pumili ng probinsya.</div>
            </div>
            <div class="question-item">
                <label for="municipality" class="form-label required">Municipality:</label>
                <select class="form-select" id="municipality" name="municipality" required>
                    <option value="" disabled selected hidden>Select Municipality</option>
                </select>
                <div class="invalid-feedback">Pumili ng munisipyo.</div>
            </div>
            <div class="question-item">
                <label for="barangay" class="form-label required">Barangay:</label>
                <select class="form-select" id="barangay" name="barangay" required>
                    <option value="" disabled selected hidden>Select Barangay</option>
                </select>
                <div class="invalid-feedback">Pumili ng barangay.</div>
            </div>
            <div class="question-item">
                <label for="parent_group_name" class="form-label required">Pangalan ng Parent Group:</label>
                <input type="text" class="form-control" id="parent_group_name" name="parent_group_name" required>
                <div class="invalid-feedback">Pangalan ng parent group ay kailangan.</div>
            </div>
        </div>
    </section>

    {% for section_name, questions_in_section in questions.items() %}
    <section class="glass-panel-0 mb-4 survey-form hidden">
        <h3>{{ section_name }}</h3>
        <div class="question-grid">
            {% for question in questions_in_section %}
                <div class="question-item">
                    <label for="q-{{ question.id }}" class="form-label required mb-1">{{ question.text }}</label>
                    {% if question.question_type == 'rating' %}
                        <select class="form-select" id="q-{{ question.id }}" name="q-{{ question.id }}" required>
                            <option value="" disabled selected hidden>Pumili</option>
                            <option value="4">4 - Lubos na sumasang-ayon</option>
                            <option value="3">3 - Sumasang-ayon</option>
                            <option value="2">2 - Hindi Sumasang-ayon</option>
                            <option value="1">1 - Lubos na Hindi Sumasang-ayon</option>
                            <option value="na">N/A - Hindi angkop</option>
                        </select>
                        <div class="invalid-feedback">Pumili ng score.</div>
                    {% else %}
                        <textarea class="form-control" id="q-{{ question.id }}" name="q-{{ question.id }}" rows="3" required></textarea>
                        <div class="invalid-feedback">Sagot ay kailangan.</div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </section>
    {% endfor %}

    <div class="text-center mt-5">
        <button type="submit" class="btn btn-primary btn-lg">Submit Assessment</button>
    </div>
</form>

<!-- <script>
document.addEventListener('DOMContentLoaded', function () {
    
    // ===== Address dropdown logic =====
    const addressData = {{ address_data | tojson | safe }};

    const provinceSelect = document.getElementById('province');

    const municipalitySelect = document.getElementById('municipality');
    const barangaySelect = document.getElementById('barangay');

    provinceSelect.addEventListener('change', function () {
        const selectedProvince = this.value;
        municipalitySelect.innerHTML = '<option value="" disabled selected hidden>Select Municipality</option>';
        barangaySelect.innerHTML = '<option value="" disabled selected hidden>Select Barangay</option>';
        console.log(addressData)
        console.log(selectedProvince)
        console.log(addressData[selectedProvince])



        if (selectedProvince && addressData[selectedProvince]) {
            
            Object.keys(addressData[selectedProvince]).forEach(function (municipality) {
                const option = document.createElement('option');
                option.value = municipality;
                option.textContent = municipality;
                municipalitySelect.appendChild(option);

            });
        }
    });

    municipalitySelect.addEventListener('change', function () {
        const selectedProvince = provinceSelect.value;
        const selectedMunicipality = this.value;
        barangaySelect.innerHTML = '<option value="" disabled selected hidden>Select Barangay</option>';

        if (selectedProvince && selectedMunicipality && addressData[selectedProvince][selectedMunicipality]) {
            addressData[selectedProvince][selectedMunicipality].forEach(function (barangay) {
                const option = document.createElement('option');
                option.value = barangay;
                option.textContent = barangay;
                barangaySelect.appendChild(option);
            });
        }
    });

    // ===== Bootstrap custom validation =====
    (function () {
      'use strict';
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    })();
});
</script> -->

<script>
    // Address dropdown logic
    document.addEventListener('DOMContentLoaded', function () {
        const addressData = JSON.parse({{ address_data | tojson  }});
        const provinceSelect = document.getElementById('province');
        const municipalitySelect = document.getElementById('municipality');
        const barangaySelect = document.getElementById('barangay');

        provinceSelect.addEventListener('change', function () {
            const selectedProvince = this.value;
            municipalitySelect.innerHTML = '<option value="" disabled selected hidden>Select Municipality</option>';
            barangaySelect.innerHTML = '<option value="" disabled selected hidden>Select Barangay</option>';

            if (selectedProvince && addressData[selectedProvince]) {
                const municipalities = Object.keys(addressData[selectedProvince]);
                municipalities.forEach(function (municipality) {
                    const option = document.createElement('option');
                    option.value = municipality;
                    option.textContent = municipality;
                    municipalitySelect.appendChild(option);
                });
            }
        });

        municipalitySelect.addEventListener('change', function () {
            const selectedProvince = provinceSelect.value;
            const selectedMunicipality = this.value;
            barangaySelect.innerHTML = '<option value="" disabled selected hidden>Select Barangay</option>';

            if (selectedProvince && selectedMunicipality && addressData[selectedProvince][selectedMunicipality]) {
                const barangays = addressData[selectedProvince][selectedMunicipality];
                barangays.forEach(function (barangay) {
                    const option = document.createElement('option');
                    option.value = barangay;
                    option.textContent = barangay;
                    barangaySelect.appendChild(option);
                });
            }
        });
    });

    // Bootstrap validation
    (function () {
      'use strict'
      var forms = document.querySelectorAll('.needs-validation')
      Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
          }
          form.classList.add('was-validated')
        }, false)
      })
    })()
</script>


<script>
document.getElementById("btnSearch").addEventListener("click", async function() {
    const hh_id = document.getElementById("household_id").value.trim();
    const alertContainer = document.getElementById("alertContainer");
    const surveyForms = document.querySelectorAll(".survey-form"); // ← all sections

    alertContainer.innerHTML = ""; 
    surveyForms.forEach(form => form.classList.add("hidden")); // hide all first

    if (!hh_id) {
        alertContainer.innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show shadow-sm mt-3" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Please enter a Household ID.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        return;
    }

    try {
        const response = await fetch(`/data/${hh_id}`);
        const result = await response.json();

        if (result.status === "success" && result.data.length > 0) {
            const info = result.data[0];

            // ✅ Fill form fields
            document.getElementById("name").value = info.first_name + ' ' + info.middle_name + ' ' + info.last_name || "";
            document.getElementById("gender").value = info.sex || "";
            document.getElementById("relation_to_hh_head").value = info.relation || "";
            document.getElementById("contact_number").value = info.contact_number || "";
            document.getElementById("province").value = info.province || "";
            document.getElementById("parent_group_name").value = info.parent_group_name || "";

            // ✅ Show all survey-form sections
            surveyForms.forEach(form => form.classList.remove("hidden"));

            alertContainer.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show shadow-sm mt-3" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    Data found and loaded successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
        } else {
            alertContainer.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show shadow-sm mt-3" role="alert">
                    <span class="fas fa-times-circle me-2"></span>
                    No record found for Household ID: ${hh_id}.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
        }
    } catch (error) {
        alertContainer.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show shadow-sm mt-3" role="alert">
                <i class="fas fa-times-circle me-2"></i>
                Error fetching data: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
    }
});
</script>

{% endblock %}

